name: Joke of the Day
on:
  schedule:
    - cron: "0 15 * * *"  # Every day at 3 PM UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tell-joke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get a random joke
        id: joke
        run: |
          RESPONSE=$(curl -s -H "Accept: application/json" https://icanhazdadjoke.com/)
          if [ $? -eq 0 ] && echo "$RESPONSE" | jq . > /dev/null 2>&1; then
            JOKE=$(echo "$RESPONSE" | jq -r .joke)
          else
            JOKE="Why don't scientists trust atoms? Because they make up everything!"
          fi

          # write output for other steps
          echo "joke=$JOKE" >> $GITHUB_OUTPUT
          # also print for logs
          echo "Today's joke: $JOKE"

      - name: Update README with daily joke
        env:
          JOKE: ${{ steps.joke.outputs.joke }}
        run: |
          DATE=$(date '+%A, %B %d, %Y')
          # Use printf to avoid heredoc/YAML indentation issues.
          # We quote all variable expansions in printf to be safe with special characters.
          printf '%s\n\n%s\n\n%s\n\n%s\n\n%s\n\n%s\n\n%s\n' \
            "# GitHub Actions Course" \
            "## ðŸ˜„ Daily Joke" \
            "**${DATE}**" \
            "> ${JOKE}" \
            "---" \
            "*This joke is automatically updated daily by GitHub Actions at 3 PM UTC*" \
            "## About This Repository\n\nThis repository contains examples and exercises for learning GitHub Actions.\n\n### Workflows Included:\n- Expressions and Contexts\n- External Events\n- Manual Triggers\n- Scheduled Jobs\n- And more!" \
            > README.md

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git diff --staged --quiet || git commit -m "ðŸ¤– Update daily joke - $(date '+%Y-%m-%d')"
          git push
